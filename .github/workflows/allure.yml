name: Allure Report

on:
  push:
    branches: [ master, dev ]
  workflow_dispatch:
    inputs:
      run_chrome:
        description: 'Запустить в Chrome'
        type: boolean
        default: true
      run_firefox:
        description: 'Запустить в Firefox'
        type: boolean
        default: false
      run_edge:
        description: 'Запустить в Edge'
        type: boolean
        default: false
      run_all_tests:
        description: 'ЗАПУСТИТЬ ВСЕ ТЕСТЫ'
        type: boolean
        default: true
      test_success:
        description: 'Тест: Успешный логин'
        type: boolean
        default: false
      test_wrong_pass:
        description: 'Тест: Неверный пароль'
        type: boolean
        default: false
      test_locked:
        description: 'Тест: Заблокированный юзер'
        type: boolean
        default: false
      test_empty:
        description: 'Тест: Пустые поля'
        type: boolean
        default: false
      test_glitch:
        description: 'Тест: Performance Glitch'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  run-tests:
    strategy:
      matrix:
        browser: [chrome, firefox, edge]
      fail-fast: false
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' || 
      (matrix.browser == 'chrome' && github.event.inputs.run_chrome == 'true') ||
      (matrix.browser == 'firefox' && github.event.inputs.run_firefox == 'true') ||
      (matrix.browser == 'edge' && github.event.inputs.run_edge == 'true')
    
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build Test Filter
        id: filter
        run: |
          if [[ "${{ github.event.inputs.run_all_tests }}" == "true" || "${{ github.event_name }}" == "push" ]]; then
            echo "tests=*" >> $GITHUB_OUTPUT
          else
            TESTS=""
            [[ "${{ github.event.inputs.test_success }}" == "true" ]] && TESTS+="testSuccessfulLogin,"
            [[ "${{ github.event.inputs.test_wrong_pass }}" == "true" ]] && TESTS+="testWrongPassword,"
            [[ "${{ github.event.inputs.test_locked }}" == "true" ]] && TESTS+="testLockedOutUser,"
            [[ "${{ github.event.inputs.test_empty }}" == "true" ]] && TESTS+="testEmptyFields,"
            [[ "${{ github.event.inputs.test_glitch }}" == "true" ]] && TESTS+="testPerformanceGlitchUser,"
            TESTS=${TESTS%,}
            if [[ -z "$TESTS" ]]; then
              echo "tests=None" >> $GITHUB_OUTPUT
            else
              echo "tests=$TESTS" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Run Maven Tests
        if: steps.filter.outputs.tests != 'None'
        run: mvn clean test -Dbrowser=${{ matrix.browser }} -Dtest=LoginTest#${{ steps.filter.outputs.tests }}
        continue-on-error: true

      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.browser }}
          path: target/allure-results
          retention-days: 1

  generate-report:
    needs: run-tests
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          path: all-results
          merge-multiple: true

      - name: Load Allure history
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Build Allure report
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: all-results
          allure_history: allure-history

      - name: Deploy Allure report
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
